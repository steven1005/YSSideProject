<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ“¬äº•å­—éŠæˆ²</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 50px;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin: 20px auto;
            width: 315px;
        }

        .cell {
            width: 100px;
            height: 100px;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            background-color: #eee;
        }

        .cell:hover {
            background-color: #ddd;
        }

        .cell.X {
            color: #007bff;
        }

        .cell.O {
            color: #dc3545;
        }

        .disabled-cell {
            cursor: not-allowed;
            background-color: #ccc;
        }

        #gameStatus {
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .loading {
            color: blue;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4 text-center">æ¨¡æ“¬äº•å­—éŠæˆ²</h1>

        <div class="board" id="gameBoard">
        </div>

        <div id="gameStatus" class="text-center"></div>
        <div id="loadingIndicator" class="loading text-center mt-3"></div>

        <div class="text-center mt-3">
            <button id="resetGameBtn" class="btn btn-secondary">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            let board = ['', '', '', '', '', '', '', '', '']; // éŠæˆ²æ£‹ç›¤ç‹€æ…‹
            let currentPlayer = 'X'; // ç•¶å‰è¼ªåˆ°èª°ä¸‹æ£‹
            let gameActive = true; // éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œ
            const winningCombos = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];

            // å‰µå»ºæ£‹ç›¤æ ¼
            function createBoard() {
                for (let i = 0; i < 9; i++) {
                    const cell = $('<div>').addClass('cell').attr('data-index', i);
                    $('#gameBoard').append(cell);
                }
            }

            // æ›´æ–°æ£‹ç›¤æ ¼é¡¯ç¤º
            function updateBoardDisplay() {
                $('.cell').each(function () {
                    const index = $(this).data('index');
                    $(this).text(board[index]);
                    if (board[index] === 'X') {
                        $(this).addClass('X').removeClass('O disabled-cell');
                    } else if (board[index] === 'O') {
                        $(this).addClass('O').removeClass('X disabled-cell');
                    } else {
                        $(this).removeClass('X O');
                        if (gameActive) {
                            $(this).removeClass('disabled-cell');
                        } else {
                            $(this).addClass('disabled-cell');
                        }
                    }
                });
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ç²å‹è€…
            function checkWinner() {
                for (const combo of winningCombos) {
                    const [a, b, c] = combo;
                    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                        return board[a]; // è¿”å›ç²å‹è€… 'X' æˆ– 'O'
                    }
                }
                // æª¢æŸ¥æ˜¯å¦å¹³å±€
                if (!board.includes('')) {
                    return 'draw'; // å¹³å±€
                }
                return null; // éŠæˆ²æœªçµæŸ
            }

            // è™•ç†ç©å®¶ä¸‹æ£‹
            function handleCellClick(event) {
                const cell = $(event.target);
                const index = cell.data('index');

                if (board[index] === '' && gameActive && currentPlayer === 'X') {
                    $('#loadingIndicator').text('è¼ªåˆ°é›»è…¦æ€è€ƒ...');
                    cell.text(currentPlayer);
                    board[index] = currentPlayer;
                    cell.addClass(currentPlayer); // å¢åŠ  X æˆ– O çš„ class
                    cell.addClass('disabled-cell'); // é»æ“Šå¾Œç¦ç”¨

                    const winner = checkWinner();
                    if (winner) {
                        endGame(winner);
                        return;
                    }

                    currentPlayer = 'O'; // åˆ‡æ›åˆ°é›»è…¦ï¼ˆOï¼‰
                    updateStatus();

                    // --- æ¨¡æ“¬é›»è…¦ Ajax å›æ‡‰ ---
                    // å»¶é²ä¸€æ®µæ™‚é–“è®“é›»è…¦ã€Œæ€è€ƒã€
                    setTimeout(function () {
                        simulateComputerMove();
                    }, 1200); // æ¨¡æ“¬ 1.2 ç§’å»¶é²
                }
            }

            // æ¨¡æ“¬é›»è…¦ç§»å‹• (ç°¡åŒ–ï¼šéš¨æ©Ÿæ‰¾ä¸€å€‹ç©ºæ ¼ä¸‹æ£‹)
            function simulateComputerMove() {
                const emptyCells = [];
                $('.cell').each(function () {
                    const index = $(this).data('index');
                    if (board[index] === '') {
                        emptyCells.push(index);
                    }
                });

                if (emptyCells.length > 0 && gameActive) {
                    const randomIndex = Math.floor(Math.random() * emptyCells.length);
                    const computerMoveIndex = emptyCells[randomIndex];

                    // æ¨¡æ“¬ Ajax æˆåŠŸå›æ‡‰
                    var mockResponse = {
                        move_index: computerMoveIndex,
                        player: 'O'
                    };
                    $('#gameBoard').trigger('computerMoveSuccess', [mockResponse]);
                } else {
                    // å¦‚æœæ²’æœ‰ç©ºä½ï¼Œå¯èƒ½å·²ç¶“å¹³å±€
                    if (gameActive) {
                        endGame('draw');
                    }
                }
                $('#loadingIndicator').text(''); // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
            }

            // ç¶å®šè‡ªè¨‚çš„ computerMoveSuccess äº‹ä»¶
            $(document).on('computerMoveSuccess', function (event, mockData) {
                const computerIndex = mockData.move_index;
                const player = mockData.player;

                if (board[computerIndex] === '' && gameActive) {
                    board[computerIndex] = player;
                    updateBoardDisplay();

                    const winner = checkWinner();
                    if (winner) {
                        endGame(winner);
                    } else {
                        currentPlayer = 'X'; // åˆ‡æ›å›ç©å®¶ (X)
                        updateStatus();
                    }
                }
            });


            // æ›´æ–°éŠæˆ²ç‹€æ…‹æ–‡å­—
            function updateStatus() {
                if (!gameActive) return;
                if (currentPlayer === 'X') {
                    $('#gameStatus').text("è¼ªåˆ°æ‚¨ (X)");
                } else {
                    $('#gameStatus').text("è¼ªåˆ°é›»è…¦ (O)...");
                }
            }

            // çµæŸéŠæˆ²
            function endGame(winner) {
                gameActive = false;
                let statusText = '';
                if (winner === 'X') {
                    statusText = "æ‚¨è´äº†ï¼ğŸ‰";
                    $('#gameStatus').text(statusText).addClass('alert alert-success');
                } else if (winner === 'O') {
                    statusText = "é›»è…¦è´äº†ï¼ğŸ˜­";
                    $('#gameStatus').text(statusText).addClass('alert alert-danger');
                } else if (winner === 'draw') {
                    statusText = "å¹³å±€ï¼ğŸ¤";
                    $('#gameStatus').text(statusText).addClass('alert alert-secondary');
                }
                // ç¦ç”¨æ‰€æœ‰æ£‹ç›¤æ ¼
                $('.cell').addClass('disabled-cell');
            }

            // é‡è¨­éŠæˆ²
            function resetGame() {
                board = ['', '', '', '', '', '', '', '', ''];
                currentPlayer = 'X';
                gameActive = true;
                $('#gameStatus').text("éŠæˆ²é–‹å§‹ï¼").removeClass().addClass('');
                updateBoardDisplay();
                $('#loadingIndicator').text('');
            }

            // åˆå§‹åŒ–
            createBoard();
            updateBoardDisplay();
            updateStatus();

            // äº‹ä»¶ç¶å®š
            $('#gameBoard').on('click', '.cell', handleCellClick);
            $('#resetGameBtn').on('click', resetGame);
        });
    </script>
</body>

</html>